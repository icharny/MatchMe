<html>
  <head>
    <title>Match Me</title>
    <script src="//www.parsecdn.com/js/parse-1.3.0.min.js"></script>
    <style>
      body { font-family: Helvetica, Arial, sans-serif; }
      div.form { width: 800px; margin: 40px auto; padding: 20px; border: 2px solid #5298fc; }
      h1 { font-size: 30px; margin: 0; }
      p { margin: 40px 0; }
      em { font-family: monospace; }
      a { color: #5298fc; text-decoration: none; }
      .right { float: right; } 
      .hide { display: none; } 
    </style>
  </head>
  <body>
    <script type="text/javascript">
      Parse.initialize("nDGRpIgZRdxJzxymmMDWPapgVLlq6Y8D2WoiMMQY", "51BnnzvOtjNzafhXlE5qkhRvv62hA8XVI1Awrm4k");

      // Load the SDK asynchronously
      (function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src = "//connect.facebook.net/en_US/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
      }(document, 'script', 'facebook-jssdk'));

      window.fbAsyncInit = function() {
        FB.init({
        //Parse.FacebookUtils.init({
          // Live AppID:
          // appId      : '1660828460810119',
          // Test AppID:
          appId      : '1660904827469149',
          cookie     : true,  // enable cookies to allow the server to access 
                              // the session
          xfbml      : true,  // parse social plugins on this page
          version    : 'v2.1' // use version 2.1
        });

        FB.getLoginStatus(function(response) {
          statusChangeCallback(response);
        });
        // Parse.FacebookUtils.logIn("publish_actions,email", {
        //     success: function(user) {
        //       if (!user.existed()) {
        //         alert("User signed up and logged in through Facebook!");
        //       } else {
        //         alert("User logged in through Facebook!");
        //       }
        //       testAPI();
        //     },
        //     error: function(user, error) {
        //       alert("User cancelled the Facebook login or did not fully authorize.");
        //     }
        //   });
      };

      // This is called with the results from from FB.getLoginStatus().
      function statusChangeCallback(response) {
        // The response object is returned with a status field that lets the
        // app know the current login status of the person.
        // Full docs on the response object can be found in the documentation
        // for FB.getLoginStatus().
        if (response.status === 'connected') {
          // Logged into your app and Facebook.
          testAPI();
        } else {
          // The person is not logged into Facebook, so we're not sure if
          // they are logged into this app or not.
          // Parse.FacebookUtils.logIn("publish_actions,email", {
          //   success: function(user) {
          //     if (!user.existed()) {
          //       alert("User signed up and logged in through Facebook!");
          //     } else {
          //       alert("User logged in through Facebook!");
          //     }
          //     testAPI();
          //   },
          //   error: function(user, error) {
          //     alert("User cancelled the Facebook login or did not fully authorize.");
          //   }
          // });

          FB.login(function(response){
            testAPI();
          }, {scope: 'publish_actions'});
        }
      }

      // Now that we've initialized the JavaScript SDK, we call 
      // FB.getLoginStatus().  This function gets the state of the
      // person visiting this page and can return one of three states to
      // the callback you provide.  They can be:
      //
      // 1. Logged into your app ('connected')
      // 2. Logged into Facebook, but not your app ('not_authorized')
      // 3. Not logged into Facebook and can't tell if they are logged into
      //    your app or not.
      //
      // These three cases are handled in the callback function.

      // Here we run a very simple test of the Graph API after login is
      // successful.  See statusChangeCallback() for when this call is made.
      function testAPI() {
        var response = FB.getAuthResponse();
        console.log(response);
        userID = response.userID;
        FB.api(
          "/me/taggable_friends",
          function (response) {
            if (response && !response.error) {
              /* handle the result */
              var select = document.getElementById("friends");
              var listOfFriends = response.data.sort(function(a, b){
                var keyA = a.name.toLowerCase();
                var keyB = b.name.toLowerCase();
                // Compare the 2 names
                if(keyA < keyB) return -1;
                if(keyA > keyB) return 1;
                return 0;
              });
              if (listOfFriends.length > 0) {
                select.disabled = false;
                var option = document.createElement('option');
                option.text = "(select all)";
                option.value = -2;
                select.appendChild(option);
                for(var i = 0; i < listOfFriends.length; i++) {
                  option = document.createElement('option');
                  option.text = listOfFriends[i].name;
                  option.value = listOfFriends[i].id;
                  select.appendChild(option);
                }
              }
              else {
                select.disabled = true;
                var option = document.createElement('option');
                  option.text = "No friends :-(";
                  select.appendChild(option);
              }
            }
            else {
              select.disabled = true;
                var option = document.createElement('option');
                option.text = "No friends :-(";
                select.appendChild(option);
            }
          }
        );
      }

      var userID = "";

      var charitiesArray = [
      {charityName:"Charity #1", id:"charity1", description:"This is a long description of charity #1. Charity #1 helps someone with something. Sometimes..."}, 
      {charityName:"Charity #2", id:"charity2", description:"This is a long description of charity #2. Charity #2 helps someone with something. Sometimes..."},
      {charityName:"Charity #3", id:"charity3", description:"This is a long description of charity #3. Charity #3 helps someone with something. Sometimes..."},
      {charityName:"Charity #4", id:"charity4", description:"This is a long description of charity #4. Charity #4 helps someone with something. Sometimes..."},
      {charityName:"Charity #5", id:"charity5", description:"This is a long description of charity #5. Charity #5 helps someone with something. Sometimes..."}];
    </script>
    
    <div class="form">
      <div id='charityList'>
      </div>
      <script type="text/javascript">
        var charities = document.getElementById('charityList');
        for (var i = 0; i < charitiesArray.length; i++) {
          var closeTag = 'href_close_'+i;
          var descriptionTag = 'div_description_'+i;
          var charity = document.createElement('div');
          charity.innerHTML=charitiesArray[i]["charityName"];
          charities.appendChild(charity)
          var detailsButton = document.createElement('a');
          detailsButton.innerHTML='Details';
          detailsButton.setAttribute("class", "right");
          detailsButton.setAttribute("href", "javascript:toggle_expand("+closeTag+", "+descriptionTag+",'inline')");
          detailsButton.setAttribute("id", "href_about"+i);
          charity.appendChild(detailsButton);
          charity.appendChild(document.createElement('br'));
          var closeButton = document.createElement('a');
          closeButton.innerHTML='(close)';
          closeButton.setAttribute("class", "right hide");
          closeButton.setAttribute("href", "javascript:toggle_expand("+closeTag+", "+descriptionTag+",'none')");
          closeButton.setAttribute("id", closeTag);
          charity.appendChild(closeButton);
          var details = document.createElement('div');
          details.innerHTML=charitiesArray[i]["description"]+'<br>';
          details.setAttribute("class", "hide");
          details.setAttribute("id", descriptionTag);
          charity.appendChild(details);
          charity.appendChild(document.createElement('br'));
        };

        function toggle_expand(id1, id2, type) {
          id1.style.display = type;
          id2.style.display = type;
        }
      </script>
      Amount: <input type="text" name="amount" id="amount">
      <br>
      Charity: <select name="charity" id='charitiesDropdown'></select>
      <script type="text/javascript">
        var charitiesDropdown = document.getElementById('charitiesDropdown');
        for (var i = 0; i < charitiesArray.length; i++) {
          var option = document.createElement('option');
          option.text = charitiesArray[i]["charityName"];
          option.value = charitiesArray[i]["id"];
          charitiesDropdown.appendChild(option);
        }
      </script>
      <br>
      <textarea rows="10" cols="50" id="whyImportant">This charity is important to me because </textarea>
      <br>
      Tag some friends: <select multiple id="friends" name="friends" enabled="false"></select>
      <br>
      <br>
      <input type="button" value="Let's do this!" onclick="confirmCampaign()">
      <script type="text/javascript">
      function confirmCampaign() {
        var amount = document.getElementById("amount").value;
        var charitiesDropdown = document.getElementById("charitiesDropdown");
        var charity = charitiesDropdown.options[charitiesDropdown.selectedIndex].text;
        var charityID = charitiesDropdown.options[charitiesDropdown.selectedIndex].value;
        var why = document.getElementById("whyImportant").value;
        var friendsMultiselect = document.getElementById("friends");
        var friends = new Array();
        var friendIDs = new Array();
        for (var i = 1; i < friendsMultiselect.options.length; i++) {
          if (friendsMultiselect.options[i].selected || friendsMultiselect.options[0].selected) {
            friends.push(friendsMultiselect.options[i].text);
            friendIDs.push(friendsMultiselect.options[i].value);
          }
        }
        alert("Amount: " + amount + "\nCharity: " + charity + "\nWhy: " + why + "\nFriends: " + friends);

        var Campaign = Parse.Object.extend("Campaign");
        var campaign = new Campaign();
         
        campaign.set("initiator", userID);
        campaign.set("amount", amount);
        campaign.set("charity", charityID);
        campaign.set("reason", why);
        campaign.set("friends", friendIDs);

        campaign.save(null, {
          success: function(gameScore) {
            // Execute any campaign that should take place after the object is saved.
            alert('New object created with objectId: ' + campaign.id);
          },
          error: function(campaign, error) {
            // Execute any logic that should take place if the save fails.
            // error is a Parse.Error with an error code and message.
            alert('Failed to create new object, with error code: ' + error.message);
          }
        });
      }
      </script>
    </div>
  </body>
</html>
